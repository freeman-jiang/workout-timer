<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Workout Timer</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="dist/output.css">
  <style>
    [x-cloak] { display: none !important; }
    input[type="number"]::-webkit-inner-spin-button { opacity: 1; }
  </style>
</head>
<body class="bg-slate-900 text-white min-h-screen transition-colors duration-300">

  <!-- Timer Screen -->
  <div id="timerScreen" class="screen flex flex-col items-center justify-center min-h-screen p-6">
    <div id="phaseLabel" class="text-lg tracking-[0.2em] uppercase opacity-80 mb-2">Ready</div>
    <div id="exerciseName" class="text-2xl font-semibold mb-2 text-center"></div>
    <div id="timer" class="text-8xl font-extralight tabular-nums mb-2">00:45</div>
    <div id="roundInfo" class="text-lg opacity-70 mb-2">-</div>
    <div id="nextUp" class="text-base opacity-60 mb-8 h-6"></div>

    <div id="controls" class="flex gap-4 mb-8 w-full max-w-xs">
      <button id="startBtn" class="flex-1 bg-white/20 hover:bg-white/30 active:scale-95 py-4 px-8 rounded-full text-lg font-medium transition-all">Start</button>
      <button id="resetBtn" class="bg-white/10 hover:bg-white/20 active:scale-95 py-4 px-6 rounded-full text-lg transition-all">Reset</button>
    </div>

    <div id="settings" class="w-full max-w-xs bg-white/10 backdrop-blur rounded-2xl p-5 space-y-4">
      <div class="flex items-center justify-between">
        <label class="text-sm opacity-90">Workout</label>
        <select id="workoutSelect" class="bg-white/20 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-white/50">
          <option value="">Quick Timer</option>
        </select>
      </div>
      <div id="quickSettings" class="flex items-center justify-between">
        <label class="text-sm opacity-90">Work / Rest</label>
        <div class="flex items-center gap-2">
          <input type="number" id="workTime" value="45" min="5" max="300" class="w-16 bg-white/20 rounded-lg px-3 py-2 text-sm text-center outline-none focus:ring-2 focus:ring-white/50">
          <span class="opacity-60">/</span>
          <input type="number" id="restTime" value="15" min="5" max="300" class="w-16 bg-white/20 rounded-lg px-3 py-2 text-sm text-center outline-none focus:ring-2 focus:ring-white/50">
        </div>
      </div>
      <div id="roundsRow" class="flex items-center justify-between">
        <label class="text-sm opacity-90">Rounds</label>
        <input type="number" id="rounds" value="8" min="1" max="50" class="w-20 bg-white/20 rounded-lg px-3 py-2 text-sm text-center outline-none focus:ring-2 focus:ring-white/50">
      </div>
      <button id="manageWorkoutsBtn" class="w-full bg-white/10 hover:bg-white/20 py-3 rounded-xl text-sm transition-all">Manage Workouts</button>
    </div>
  </div>

  <!-- Workouts List Screen -->
  <div id="workoutsScreen" class="screen hidden flex-col items-center p-6 pt-12 min-h-screen">
    <h1 class="text-2xl font-semibold mb-6">My Workouts</h1>
    <div id="workoutList" class="w-full max-w-md space-y-3 mb-6"></div>
    <div class="flex gap-3 w-full max-w-md">
      <button id="newWorkoutBtn" class="flex-1 bg-white/20 hover:bg-white/30 active:scale-95 py-4 rounded-full text-base font-medium transition-all">+ New Workout</button>
      <button id="backToTimerBtn" class="bg-white/10 hover:bg-white/20 active:scale-95 py-4 px-6 rounded-full text-base transition-all">Back</button>
    </div>
  </div>

  <!-- Workout Editor Screen -->
  <div id="editorScreen" class="screen hidden flex-col items-center p-6 pt-12 min-h-screen">
    <h1 id="editorTitle" class="text-2xl font-semibold mb-6">New Workout</h1>
    
    <div class="w-full max-w-md bg-white/10 backdrop-blur rounded-2xl p-5 space-y-4 mb-6">
      <div class="flex items-center justify-between gap-4">
        <label class="text-sm opacity-90 shrink-0">Name</label>
        <input type="text" id="workoutName" placeholder="e.g. Upper Body" class="flex-1 bg-white/20 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-white/50">
      </div>
      <div class="flex items-center justify-between">
        <label class="text-sm opacity-90">Work (sec)</label>
        <input type="number" id="editorWorkTime" value="45" min="5" max="300" class="w-20 bg-white/20 rounded-lg px-3 py-2 text-sm text-center outline-none focus:ring-2 focus:ring-white/50">
      </div>
      <div class="flex items-center justify-between">
        <label class="text-sm opacity-90">Rest (sec)</label>
        <input type="number" id="editorRestTime" value="15" min="5" max="300" class="w-20 bg-white/20 rounded-lg px-3 py-2 text-sm text-center outline-none focus:ring-2 focus:ring-white/50">
      </div>
    </div>

    <div class="w-full max-w-md">
      <h3 class="text-base font-medium opacity-80 mb-3">Exercises</h3>
      <div class="flex gap-2 mb-4">
        <input type="text" id="newExerciseInput" placeholder="Add exercise..." class="flex-1 bg-white/20 rounded-lg px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-white/50">
        <button id="addExerciseBtn" class="bg-white/20 hover:bg-white/30 active:scale-95 px-5 py-3 rounded-lg text-sm font-medium transition-all">Add</button>
      </div>
      <div id="exerciseList" class="space-y-2 max-h-64 overflow-y-auto mb-6"></div>
    </div>

    <div class="flex gap-3 w-full max-w-md">
      <button id="saveWorkoutBtn" class="flex-1 bg-white/20 hover:bg-white/30 active:scale-95 py-4 rounded-full text-base font-medium transition-all">Save</button>
      <button id="cancelEditBtn" class="bg-white/10 hover:bg-white/20 active:scale-95 py-4 px-6 rounded-full text-base transition-all">Cancel</button>
    </div>
    <button id="deleteWorkoutBtn" class="hidden mt-4 bg-red-500/30 hover:bg-red-500/50 active:scale-95 py-3 px-6 rounded-full text-sm transition-all">Delete Workout</button>
  </div>

  <script>
    // ============ Storage ============
    const STORAGE_KEY = 'workout-timer-workouts';
    const loadWorkouts = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; } };
    const saveWorkouts = (w) => localStorage.setItem(STORAGE_KEY, JSON.stringify(w));

    // ============ State ============
    let workouts = loadWorkouts();
    let currentWorkout = null;
    let editingWorkoutId = null;
    let editorExercises = [];
    let isRunning = false, isPaused = false;
    let currentPhase = 'warmup', currentRound = 1, timeRemaining = 0, intervalId = null;
    const WARMUP_TIME = 5;

    // ============ Audio ============
    let audioCtx = null;
    const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); };
    const playBeep = (freq = 800, dur = 150, count = 1) => {
      if (!audioCtx) return;
      for (let i = 0; i < count; i++) {
        setTimeout(() => {
          const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
          osc.connect(gain); gain.connect(audioCtx.destination);
          osc.frequency.value = freq; osc.type = 'sine';
          gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur / 1000);
          osc.start(); osc.stop(audioCtx.currentTime + dur / 1000);
        }, i * 200);
      }
    };

    // ============ DOM ============
    const $ = id => document.getElementById(id);
    const screens = { timer: $('timerScreen'), workouts: $('workoutsScreen'), editor: $('editorScreen') };
    const el = {
      phaseLabel: $('phaseLabel'), exerciseName: $('exerciseName'), timer: $('timer'),
      roundInfo: $('roundInfo'), nextUp: $('nextUp'), startBtn: $('startBtn'),
      settings: $('settings'), workoutSelect: $('workoutSelect'), quickSettings: $('quickSettings'),
      roundsRow: $('roundsRow'), workTime: $('workTime'), restTime: $('restTime'), rounds: $('rounds'),
      editorTitle: $('editorTitle'), workoutName: $('workoutName'),
      editorWorkTime: $('editorWorkTime'), editorRestTime: $('editorRestTime'),
      exerciseList: $('exerciseList'), newExerciseInput: $('newExerciseInput'), deleteBtn: $('deleteWorkoutBtn')
    };

    // ============ Navigation ============
    const showScreen = (name) => {
      Object.entries(screens).forEach(([k, s]) => {
        s.classList.toggle('hidden', k !== name);
        s.classList.toggle('flex', k === name);
      });
    };

    // ============ Timer Logic ============
    const getWorkTime = () => currentWorkout ? currentWorkout.workTime : parseInt(el.workTime.value);
    const getRestTime = () => currentWorkout ? currentWorkout.restTime : parseInt(el.restTime.value);
    const getRounds = () => currentWorkout ? currentWorkout.exercises.length : parseInt(el.rounds.value);
    const getCurrentExercise = () => currentWorkout?.exercises[currentRound - 1] || null;
    const getNextExercise = () => currentWorkout?.exercises[currentRound] || null;
    const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

    const updateDisplay = () => {
      el.timer.textContent = formatTime(timeRemaining);
      if (currentPhase === 'warmup') {
        el.phaseLabel.textContent = 'Get Ready';
        el.exerciseName.textContent = currentWorkout?.exercises[0] || '';
        el.roundInfo.textContent = 'Starting soon...';
        el.nextUp.textContent = '';
      } else {
        el.phaseLabel.textContent = currentPhase === 'work' ? 'Work' : 'Rest';
        el.exerciseName.textContent = getCurrentExercise() || '';
        el.roundInfo.textContent = `Round ${currentRound} of ${getRounds()}`;
        el.nextUp.textContent = currentPhase === 'rest' && getNextExercise() ? `Next: ${getNextExercise()}` : '';
      }
      document.body.classList.remove('bg-slate-900', 'bg-work', 'bg-rest', 'bg-warmup');
      document.body.classList.add(isRunning || isPaused ? `bg-${currentPhase}` : 'bg-slate-900');
    };

    const tick = () => {
      if (timeRemaining > 0) {
        timeRemaining--;
        if (timeRemaining <= 3 && timeRemaining > 0) playBeep(600, 100);
        updateDisplay();
      } else {
        if (currentPhase === 'warmup') { playBeep(1000, 200, 2); currentPhase = 'work'; timeRemaining = getWorkTime(); }
        else if (currentPhase === 'work') { playBeep(1000, 200, 2); currentPhase = 'rest'; timeRemaining = getRestTime(); }
        else {
          if (currentRound >= getRounds()) {
            playBeep(1200, 300, 3); stopTimer();
            el.phaseLabel.textContent = 'Done!'; el.exerciseName.textContent = '';
            el.roundInfo.textContent = 'Workout complete'; el.nextUp.textContent = '';
            return;
          }
          playBeep(800, 200, 2); currentRound++; currentPhase = 'work'; timeRemaining = getWorkTime();
        }
        updateDisplay();
      }
    };

    const startTimer = () => {
      initAudio();
      if (!isRunning && !isPaused) { currentPhase = 'warmup'; currentRound = 1; timeRemaining = WARMUP_TIME; }
      isRunning = true; isPaused = false;
      el.startBtn.textContent = 'Pause';
      el.settings.classList.add('hidden');
      updateDisplay();
      intervalId = setInterval(tick, 1000);
    };

    const pauseTimer = () => { isRunning = false; isPaused = true; el.startBtn.textContent = 'Resume'; clearInterval(intervalId); };
    const stopTimer = () => { isRunning = false; isPaused = false; clearInterval(intervalId); el.startBtn.textContent = 'Start'; el.settings.classList.remove('hidden'); };

    const resetTimer = () => {
      stopTimer(); currentPhase = 'warmup'; currentRound = 1;
      el.phaseLabel.textContent = 'Ready'; el.exerciseName.textContent = '';
      el.roundInfo.textContent = '-'; el.nextUp.textContent = '';
      document.body.classList.remove('bg-work', 'bg-rest', 'bg-warmup');
      document.body.classList.add('bg-slate-900');
      el.timer.textContent = formatTime(getWorkTime());
    };

    // ============ Workout Selection ============
    const populateWorkoutSelect = () => {
      el.workoutSelect.innerHTML = '<option value="">Quick Timer</option>' + 
        workouts.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
    };

    const selectWorkout = (id) => {
      currentWorkout = id ? workouts.find(w => w.id === id) : null;
      el.quickSettings.classList.toggle('hidden', !!id);
      el.roundsRow.classList.toggle('hidden', !!id);
      resetTimer();
    };

    // ============ Workouts List ============
    const renderWorkoutList = () => {
      const list = $('workoutList');
      if (!workouts.length) {
        list.innerHTML = '<p class="text-center opacity-60 py-8">No workouts yet. Create one!</p>';
        return;
      }
      list.innerHTML = workouts.map(w => `
        <div class="bg-white/10 rounded-xl p-4 flex items-center justify-between" data-id="${w.id}">
          <div>
            <h3 class="font-medium">${w.name}</h3>
            <p class="text-sm opacity-60">${w.exercises.length} exercises Â· ${w.workTime}s/${w.restTime}s</p>
          </div>
          <button onclick="editWorkout('${w.id}')" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-sm transition-all">Edit</button>
        </div>
      `).join('');
    };

    // ============ Workout Editor ============
    const openEditor = (id = null) => {
      editingWorkoutId = id;
      if (id) {
        const w = workouts.find(x => x.id === id);
        el.editorTitle.textContent = 'Edit Workout';
        el.workoutName.value = w.name;
        el.editorWorkTime.value = w.workTime;
        el.editorRestTime.value = w.restTime;
        editorExercises = [...w.exercises];
        el.deleteBtn.classList.remove('hidden');
      } else {
        el.editorTitle.textContent = 'New Workout';
        el.workoutName.value = '';
        el.editorWorkTime.value = 45;
        el.editorRestTime.value = 15;
        editorExercises = [];
        el.deleteBtn.classList.add('hidden');
      }
      renderExerciseList();
      showScreen('editor');
    };

    const renderExerciseList = () => {
      if (!editorExercises.length) {
        el.exerciseList.innerHTML = '<p class="text-center opacity-60 py-6">No exercises added</p>';
        return;
      }
      el.exerciseList.innerHTML = editorExercises.map((ex, i) => `
        <div class="bg-white/10 rounded-lg px-4 py-3 flex items-center justify-between">
          <span class="text-sm">${i + 1}. ${ex}</span>
          <button onclick="removeExercise(${i})" class="text-white/60 hover:text-white text-lg leading-none">&times;</button>
        </div>
      `).join('');
    };

    const addExercise = () => {
      const name = el.newExerciseInput.value.trim();
      if (name) { editorExercises.push(name); el.newExerciseInput.value = ''; renderExerciseList(); }
    };

    window.removeExercise = (i) => { editorExercises.splice(i, 1); renderExerciseList(); };
    window.editWorkout = (id) => openEditor(id);

    const saveWorkout = () => {
      const name = el.workoutName.value.trim();
      if (!name) return alert('Please enter a workout name');
      if (!editorExercises.length) return alert('Please add at least one exercise');
      const workout = {
        id: editingWorkoutId || crypto.randomUUID(),
        name, workTime: parseInt(el.editorWorkTime.value),
        restTime: parseInt(el.editorRestTime.value),
        exercises: [...editorExercises]
      };
      if (editingWorkoutId) {
        const idx = workouts.findIndex(w => w.id === editingWorkoutId);
        if (idx >= 0) workouts[idx] = workout;
      } else workouts.push(workout);
      saveWorkouts(workouts);
      populateWorkoutSelect();
      showScreen('workouts');
      renderWorkoutList();
    };

    const deleteWorkout = () => {
      if (!editingWorkoutId || !confirm('Delete this workout?')) return;
      workouts = workouts.filter(w => w.id !== editingWorkoutId);
      saveWorkouts(workouts);
      populateWorkoutSelect();
      if (currentWorkout?.id === editingWorkoutId) { currentWorkout = null; el.workoutSelect.value = ''; selectWorkout(''); }
      showScreen('workouts');
      renderWorkoutList();
    };

    // ============ Event Listeners ============
    el.startBtn.onclick = () => isRunning ? pauseTimer() : startTimer();
    $('resetBtn').onclick = resetTimer;
    el.workoutSelect.onchange = (e) => selectWorkout(e.target.value);
    el.workTime.onchange = () => { if (!isRunning && !isPaused) el.timer.textContent = formatTime(getWorkTime()); };
    $('manageWorkoutsBtn').onclick = () => { renderWorkoutList(); showScreen('workouts'); };
    $('backToTimerBtn').onclick = () => showScreen('timer');
    $('newWorkoutBtn').onclick = () => openEditor();
    $('addExerciseBtn').onclick = addExercise;
    el.newExerciseInput.onkeypress = (e) => { if (e.key === 'Enter') addExercise(); };
    $('saveWorkoutBtn').onclick = saveWorkout;
    $('cancelEditBtn').onclick = () => { showScreen('workouts'); renderWorkoutList(); };
    el.deleteBtn.onclick = deleteWorkout;

    // ============ Init ============
    populateWorkoutSelect();
    el.timer.textContent = formatTime(parseInt(el.workTime.value));
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});
  </script>
</body>
</html>
